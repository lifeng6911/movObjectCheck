# 心跳机制快速测试指南

## 测试步骤（Windows）

### 步骤1：启动服务器

双击运行或在命令行执行：
```cmd
scripts\start_server.bat
```

**预期输出**：
```
============================================================
心跳机制测试 - 服务器端
============================================================

[OK] Python依赖已安装

============================================================
启动服务器
============================================================

服务器启动成功，监听 0.0.0.0:8888
心跳超时设置: 90秒
设备检查间隔: 10秒
============================================================
设备监控线程启动
```

### 步骤2：启动客户端（另一个终端）

**注意**：由于您在Windows环境且可能没有摄像头，需要先修改代码：

#### 2.1 修改代码跳过摄像头检查（仅用于测试）

编辑 `src/motion_detector.cpp`，找到 `initialize()` 函数，修改为：

```cpp
bool MotionDetector::initialize() {
    // 测试模式：跳过摄像头初始化
    std::cout << "摄像头初始化成功（测试模式）" << std::endl;
    return true;

    /* 原代码注释掉
    cap_.open(config_.camera_index);
    if (!cap_.isOpened()) {
        std::cerr << "无法打开摄像头" << std::endl;
        return false;
    }
    // ... 其他代码
    */
}
```

同时修改 `detectMotion()` 函数：

```cpp
bool MotionDetector::detectMotion(cv::Mat& output_frame) {
    // 测试模式：不检测运动，只保持连接
    sleep(1);
    return false;

    /* 原代码注释掉
    cv::Mat frame, gray, blur_frame;
    cap_ >> frame;
    // ... 其他代码
    */
}
```

#### 2.2 重新编译

```bash
# 如果在WSL或Git Bash
./scripts/build.sh

# 或使用CMake（Windows）
mkdir build
cd build
cmake ..
cmake --build .
```

#### 2.3 启动客户端

```cmd
scripts\start_client.bat
```

**预期输出**：
```
[OK] 测试配置已创建
启动客户端...

=== 移动物体检测系统 ===
配置文件加载成功
摄像头初始化成功（测试模式）
成功连接到服务器: 127.0.0.1:8888
设备注册成功 [ID: 101, 名称: TestDevice-001]
心跳线程启动，间隔: 10秒
系统启动成功，开始监控...
```

### 步骤3：观察服务器输出

服务器终端应该显示：

```
新客户端连接: ('127.0.0.1', xxxxx)
[设备101] 新设备注册: TestDevice-001 (Test-Location-1)

============================================================
设备状态列表:
------------------------------------------------------------
[OK] 设备101: TestDevice-001
  位置: Test-Location-1
  状态: 在线
  地址: ('127.0.0.1', xxxxx)
  最后心跳: 2026-02-13 xx:xx:xx (0秒前)
  接收图像: 0张
  注册时间: 2026-02-13 xx:xx:xx
------------------------------------------------------------
总计: 1台设备 (在线: 1, 离线: 0)
============================================================
```

### 步骤4：测试心跳

等待10秒（心跳间隔），观察：
- 客户端静默发送心跳（无日志）
- 服务器静默接收心跳（无日志）
- 设备状态保持"在线"

### 步骤5：测试离线检测

1. 在客户端终端按 `Ctrl+C` 停止客户端
2. 等待约90秒（心跳超时时间）
3. 观察服务器输出

**服务器应该显示**：

```
[设备101] 客户端断开连接

============================================================
[WARNING] 检测到设备离线:
  - 设备101 (TestDevice-001)
    位置: Test-Location-1
    最后心跳: 95秒前
============================================================

设备状态列表:
------------------------------------------------------------
[ERROR] 设备101: TestDevice-001
  位置: Test-Location-1
  状态: 离线
  最后心跳: 2026-02-13 xx:xx:xx (95秒前)
------------------------------------------------------------
总计: 1台设备 (在线: 0, 离线: 1)
============================================================
```

## 测试检查清单

- [ ] 服务器成功启动
- [ ] 客户端成功连接
- [ ] 设备注册成功（显示ID、名称、位置）
- [ ] 心跳线程启动
- [ ] 设备状态显示"在线"
- [ ] 停止客户端后服务器检测到离线
- [ ] 显示离线警告和设备信息

## 如果遇到问题

### 问题1：Python依赖缺失

```cmd
pip install opencv-python numpy
```

### 问题2：端口被占用

修改配置文件中的端口：
- `config/config.ini`: `server_port = 8889`
- `config/server_config.ini`: `port = 8889`

### 问题3：无法编译

确保已安装：
- CMake
- C++编译器（MSVC或MinGW）
- OpenCV开发库

### 问题4：服务器未检测到离线

- 确认等待时间超过90秒
- 检查服务器日志是否显示"设备监控线程启动"

## 测试成功标志

如果看到以下输出，说明心跳机制工作正常：

✓ 设备注册成功
✓ 心跳线程启动
✓ 设备状态显示"在线"
✓ 停止客户端后90秒内检测到离线
✓ 显示离线设备的编号、名称、位置

## 下一步

测试通过后，可以：
1. 恢复摄像头代码用于实际部署
2. 配置多个设备进行测试
3. 调整心跳参数
4. 部署到树莓派
