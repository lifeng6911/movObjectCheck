# 心跳机制与设备管理说明

## 概述

本系统实现了完整的心跳机制和设备管理功能，解决了边缘端长时间不通讯导致的连接中断问题。服务器可以实时监控多个边缘设备的在线状态，并在设备离线时及时报警。

## 心跳机制原理

### 工作流程

```
树莓派端                           服务器端
   │                                  │
   ├──[1. 连接]──────────────────────>│
   │                                  │
   ├──[2. 注册设备]──────────────────>│
   │<─────────[注册响应]──────────────┤
   │                                  │
   ├──[3. 启动心跳线程]               │
   │                                  ├──[启动监控线程]
   │                                  │
   ├──[每30秒发送心跳]───────────────>│
   │<─────────[心跳响应]──────────────┤
   │                                  ├──[更新最后心跳时间]
   │                                  │
   ├──[检测到运动]                    │
   ├──[发送图像]─────────────────────>│
   │                                  ├──[接收图像]
   │                                  ├──[更新心跳时间]
   │                                  │
   │                                  ├──[每10秒检查设备状态]
   │                                  ├──[超过90秒无心跳→标记离线]
   │                                  ├──[显示离线设备警告]
```

### 消息协议

#### 消息头结构（8字节）

```c
struct MessageHeader {
    uint8_t type;              // 消息类型
    uint8_t reserved;          // 保留字段
    uint16_t device_id;        // 设备ID（网络字节序）
    uint32_t data_length;      // 数据长度（网络字节序）
}
```

#### 消息类型

| 类型 | 值 | 说明 | 方向 |
|------|-----|------|------|
| MSG_REGISTER | 0x04 | 设备注册 | 客户端→服务器 |
| MSG_REGISTER_ACK | 0x05 | 注册响应 | 服务器→客户端 |
| MSG_HEARTBEAT | 0x01 | 心跳消息 | 客户端→服务器 |
| MSG_HEARTBEAT_ACK | 0x02 | 心跳响应 | 服务器→客户端 |
| MSG_IMAGE_DATA | 0x03 | 图像数据 | 客户端→服务器 |

## 设备管理功能

### 设备注册

每个设备连接到服务器时必须先注册，提供以下信息：
- **设备ID**：唯一标识（1-65535）
- **设备名称**：便于识别（最多32字符）
- **设备位置**：安装位置（最多64字符）

### 设备状态监控

服务器实时跟踪每个设备的状态：

```python
class DeviceInfo:
    - device_id: 设备ID
    - device_name: 设备名称
    - location: 安装位置
    - address: 网络地址
    - last_heartbeat: 最后心跳时间
    - connected: 在线状态
    - image_count: 接收图像数量
    - register_time: 注册时间
```

### 离线检测

服务器每隔 `check_interval` 秒检查所有设备：
- 如果设备超过 `heartbeat_timeout` 秒未发送心跳
- 将设备标记为离线
- 在控制台显示警告信息
- 显示设备编号、名称、位置和最后心跳时间

## 配置参数

### 树莓派端配置 (config.ini)

```ini
# 设备信息（每台设备必须不同）
device_id = 1
device_name = RaspberryPi-001
device_location = Building-A-Floor-1

# 心跳间隔（秒）
heartbeat_interval = 30
```

### 服务器端配置 (server_config.ini)

```ini
# 心跳超时时间（秒）
# 建议设置为心跳间隔的3倍
heartbeat_timeout = 90

# 设备状态检查间隔（秒）
check_interval = 10

# 最大客户端连接数
max_clients = 10
```

## 使用示例

### 配置多个设备

#### 设备1配置 (config_device1.ini)
```ini
device_id = 1
device_name = RaspberryPi-001
device_location = Building-A-Floor-1
server_ip = 192.168.1.100
heartbeat_interval = 30
```

#### 设备2配置 (config_device2.ini)
```ini
device_id = 2
device_name = RaspberryPi-002
device_location = Building-A-Floor-2
server_ip = 192.168.1.100
heartbeat_interval = 30
```

#### 设备3配置 (config_device3.ini)
```ini
device_id = 3
device_name = RaspberryPi-003
device_location = Building-B-Entrance
server_ip = 192.168.1.100
heartbeat_interval = 30
```

### 启动设备

```bash
# 设备1
./motion_detector config/config_device1.ini

# 设备2
./motion_detector config/config_device2.ini

# 设备3
./motion_detector config/config_device3.ini
```

### 服务器输出示例

#### 设备注册成功
```
新客户端连接: ('192.168.1.101', 54321)
[设备1] 新设备注册: RaspberryPi-001 (Building-A-Floor-1)

============================================================
设备状态列表:
------------------------------------------------------------
✓ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 在线
  地址: ('192.168.1.101', 54321)
  最后心跳: 2026-02-13 10:30:00 (0秒前)
  接收图像: 0张
  注册时间: 2026-02-13 10:30:00
------------------------------------------------------------
总计: 1台设备 (在线: 1, 离线: 0)
============================================================
```

#### 设备离线警告
```
============================================================
⚠️  检测到设备离线:
  - 设备2 (RaspberryPi-002)
    位置: Building-A-Floor-2
    最后心跳: 95秒前
============================================================

============================================================
设备状态列表:
------------------------------------------------------------
✓ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 在线
  地址: ('192.168.1.101', 54321)
  最后心跳: 2026-02-13 10:30:00 (5秒前)
  接收图像: 15张
  注册时间: 2026-02-13 10:25:00
------------------------------------------------------------
✗ 设备2: RaspberryPi-002
  位置: Building-A-Floor-2
  状态: 离线
  地址: ('192.168.1.102', 54322)
  最后心跳: 2026-02-13 10:28:25 (95秒前)
  接收图像: 8张
  注册时间: 2026-02-13 10:26:00
------------------------------------------------------------
✓ 设备3: RaspberryPi-003
  位置: Building-B-Entrance
  状态: 在线
  地址: ('192.168.1.103', 54323)
  最后心跳: 2026-02-13 10:30:02 (3秒前)
  接收图像: 22张
  注册时间: 2026-02-13 10:27:00
------------------------------------------------------------
总计: 3台设备 (在线: 2, 离线: 1)
============================================================
```

## 故障处理

### 问题1：设备频繁离线

**可能原因**：
- 网络不稳定
- 心跳间隔设置过大
- 心跳超时设置过小

**解决方案**：
```ini
# 树莓派端：减小心跳间隔
heartbeat_interval = 20

# 服务器端：增加超时时间
heartbeat_timeout = 120
```

### 问题2：心跳失败导致重连

**现象**：
```
心跳响应超时
心跳失败，尝试重新连接...
```

**解决方案**：
1. 检查网络连接
2. 检查服务器是否正常运行
3. 检查防火墙设置
4. 增加连接超时时间：
   ```ini
   connection_timeout = 10000
   ```

### 问题3：设备ID冲突

**现象**：
```
[设备1] 重新连接: RaspberryPi-002 (Building-A-Floor-2)
```

**解决方案**：
确保每台设备的 `device_id` 唯一，不要重复。

## 高级功能

### TCP保活机制

树莓派端自动启用TCP保活：
```c
int keepalive = 1;
int keepidle = 60;      // 60秒无数据后开始探测
int keepinterval = 10;  // 每10秒探测一次
int keepcount = 3;      // 探测3次失败后断开
```

### 自动重连

心跳失败时自动尝试重连：
```cpp
if (!sendHeartbeat()) {
    std::cerr << "心跳失败，尝试重新连接..." << std::endl;
    reconnect();
}
```

### 线程安全

服务器使用线程锁保护设备列表：
```python
with self.device_lock:
    # 安全访问设备信息
    device.update_heartbeat()
```

## 性能指标

- **心跳开销**：每次心跳仅8字节
- **网络占用**：30秒间隔时约0.27字节/秒
- **检测延迟**：最大 `heartbeat_timeout` 秒
- **CPU占用**：心跳线程几乎不占用CPU

## 最佳实践

1. **心跳间隔设置**
   - 稳定网络：30-60秒
   - 不稳定网络：15-30秒
   - 关键应用：10-20秒

2. **超时时间设置**
   - 建议为心跳间隔的3倍
   - 最小不低于2倍

3. **设备命名规范**
   - 使用有意义的名称
   - 包含位置信息
   - 便于快速识别

4. **监控策略**
   - 定期查看设备状态
   - 设置离线告警
   - 记录离线日志

## 扩展建议

### 添加邮件告警

当设备离线时发送邮件通知：
```python
def send_alert_email(device_id, device_name):
    # 实现邮件发送逻辑
    pass
```

### 添加Web监控界面

使用Flask创建Web界面显示设备状态：
```python
from flask import Flask, render_template

@app.route('/devices')
def show_devices():
    return render_template('devices.html', devices=server.devices)
```

### 添加数据库记录

记录设备上线/离线历史：
```python
def log_device_status(device_id, status, timestamp):
    # 写入数据库
    pass
```

## 总结

心跳机制有效解决了以下问题：
- ✅ 长时间无通讯导致的连接中断
- ✅ 设备离线无法及时发现
- ✅ 多设备管理困难
- ✅ 故障设备难以定位

通过合理配置心跳参数，系统可以在低网络开销的情况下，实时监控所有边缘设备的健康状态。
