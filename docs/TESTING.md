# 心跳机制测试指南

本文档提供详细的测试步骤，验证心跳机制是否正常工作。

## 测试环境准备

### 1. 编译客户端程序

```bash
# Linux/树莓派
cd movObjectCheck
./scripts/build.sh

# Windows (使用CMake)
mkdir build
cd build
cmake ..
cmake --build .
```

### 2. 安装服务器依赖

```bash
pip install opencv-python numpy
```

## 自动测试（推荐）

### 使用Python测试脚本

```bash
# 在项目根目录运行
python scripts/test_heartbeat.py
```

该脚本会：
1. 自动启动服务器
2. 提示您在另一个终端启动客户端
3. 实时显示服务器输出
4. 按Ctrl+C停止测试

## 手动测试

### 步骤1: 启动服务器

打开第一个终端：

```bash
cd movObjectCheck
python server/server.py
```

**预期输出**：
```
配置文件加载成功: config/server_config.ini
服务器启动成功，监听 0.0.0.0:8888
心跳超时设置: 90秒
设备检查间隔: 10秒
============================================================
设备监控线程启动
```

### 步骤2: 启动客户端（设备1）

打开第二个终端：

```bash
cd movObjectCheck
./build/motion_detector config/config.ini
```

**预期输出**：
```
=== 移动物体检测系统 ===
配置文件加载成功
摄像头初始化成功
成功连接到服务器: 192.168.1.100:8888
设备注册成功 [ID: 1, 名称: RaspberryPi-001]
心跳线程启动，间隔: 30秒
系统启动成功，开始监控...
```

**服务器端预期输出**：
```
新客户端连接: ('127.0.0.1', 54321)
[设备1] 新设备注册: RaspberryPi-001 (Building-A-Floor-1)

============================================================
设备状态列表:
------------------------------------------------------------
✓ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 在线
  地址: ('127.0.0.1', 54321)
  最后心跳: 2026-02-13 10:30:00 (0秒前)
  接收图像: 0张
  注册时间: 2026-02-13 10:30:00
------------------------------------------------------------
总计: 1台设备 (在线: 1, 离线: 0)
============================================================
```

### 步骤3: 观察心跳消息

等待30秒（心跳间隔），观察客户端和服务器的输出。

**客户端**：
- 不会显示心跳消息（静默发送）
- 如果心跳失败会显示错误

**服务器**：
- 静默接收心跳（不显示日志）
- 设备状态保持"在线"

### 步骤4: 启动第二个设备（可选）

打开第三个终端：

```bash
# 先创建设备2的配置
cp config/config.ini config/config_device2.ini

# 编辑配置文件，修改：
# device_id = 2
# device_name = RaspberryPi-002
# device_location = Building-A-Floor-2

# 启动设备2
./build/motion_detector config/config_device2.ini
```

**服务器端预期输出**：
```
新客户端连接: ('127.0.0.1', 54322)
[设备2] 新设备注册: RaspberryPi-002 (Building-A-Floor-2)

============================================================
设备状态列表:
------------------------------------------------------------
✓ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 在线
  ...
------------------------------------------------------------
✓ 设备2: RaspberryPi-002
  位置: Building-A-Floor-2
  状态: 在线
  ...
------------------------------------------------------------
总计: 2台设备 (在线: 2, 离线: 0)
============================================================
```

### 步骤5: 测试离线检测

停止其中一个客户端（按Ctrl+C）。

等待约90秒（心跳超时时间），服务器会检测到设备离线。

**服务器端预期输出**：
```
[设备1] 客户端断开连接

============================================================
⚠️  检测到设备离线:
  - 设备1 (RaspberryPi-001)
    位置: Building-A-Floor-1
    最后心跳: 95秒前
============================================================

============================================================
设备状态列表:
------------------------------------------------------------
✗ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 离线
  地址: ('127.0.0.1', 54321)
  最后心跳: 2026-02-13 10:30:00 (95秒前)
  接收图像: 0张
  注册时间: 2026-02-13 10:30:00
------------------------------------------------------------
✓ 设备2: RaspberryPi-002
  位置: Building-A-Floor-2
  状态: 在线
  ...
------------------------------------------------------------
总计: 2台设备 (在线: 1, 离线: 1)
============================================================
```

### 步骤6: 测试设备重连

重新启动刚才停止的客户端。

**服务器端预期输出**：
```
新客户端连接: ('127.0.0.1', 54323)
[设备1] 重新连接: RaspberryPi-001 (Building-A-Floor-1)

============================================================
设备状态列表:
------------------------------------------------------------
✓ 设备1: RaspberryPi-001
  位置: Building-A-Floor-1
  状态: 在线
  ...
------------------------------------------------------------
总计: 2台设备 (在线: 2, 离线: 0)
============================================================
```

## 测试检查清单

使用以下清单验证心跳机制是否正常：

- [ ] **设备注册**
  - [ ] 客户端显示"设备注册成功"
  - [ ] 服务器显示"新设备注册"
  - [ ] 服务器显示设备ID、名称、位置

- [ ] **心跳功能**
  - [ ] 客户端显示"心跳线程启动"
  - [ ] 客户端不报心跳错误
  - [ ] 服务器设备状态保持"在线"

- [ ] **离线检测**
  - [ ] 停止客户端后90秒内服务器检测到离线
  - [ ] 服务器显示"检测到设备离线"警告
  - [ ] 服务器显示设备编号、名称、位置
  - [ ] 设备状态变为"离线"（✗标记）

- [ ] **设备重连**
  - [ ] 重启客户端后自动重连
  - [ ] 服务器显示"重新连接"
  - [ ] 设备状态恢复为"在线"（✓标记）

- [ ] **多设备管理**
  - [ ] 可以同时连接多个设备
  - [ ] 每个设备独立显示状态
  - [ ] 正确统计在线/离线设备数量

## 常见问题排查

### 问题1: 客户端无法连接服务器

**检查**：
```bash
# 检查服务器是否运行
netstat -an | grep 8888

# 测试端口连通性
telnet 127.0.0.1 8888
```

**解决**：
- 确认服务器已启动
- 检查防火墙设置
- 确认配置文件中的IP和端口正确

### 问题2: 设备注册失败

**检查客户端日志**：
```
设备注册失败
```

**解决**：
- 检查网络连接
- 确认服务器正常运行
- 增加连接超时时间

### 问题3: 心跳失败

**客户端显示**：
```
发送心跳失败
心跳响应超时
```

**解决**：
- 检查网络稳定性
- 减小心跳间隔
- 增加连接超时时间

### 问题4: 服务器未检测到离线

**可能原因**：
- 等待时间不够（需要超过heartbeat_timeout）
- 服务器监控线程未启动

**解决**：
- 等待足够长的时间（默认90秒）
- 检查服务器日志是否显示"设备监控线程启动"
- 减小heartbeat_timeout进行测试

## 性能测试

### 测试心跳网络开销

```bash
# 使用tcpdump抓包
sudo tcpdump -i lo port 8888 -w heartbeat.pcap

# 分析数据包大小
tcpdump -r heartbeat.pcap -n | grep "length"
```

**预期结果**：
- 每次心跳：8字节（消息头）
- 心跳响应：8字节（消息头）
- 总开销：16字节/次

### 测试多设备并发

启动10个设备，观察服务器性能：

```bash
# 创建10个配置文件
for i in {1..10}; do
    sed "s/device_id = 1/device_id = $i/" config/config.ini > config/test_device$i.ini
    sed -i "s/RaspberryPi-001/RaspberryPi-00$i/" config/test_device$i.ini
done

# 启动10个客户端（需要有摄像头或修改代码跳过摄像头检查）
for i in {1..10}; do
    ./build/motion_detector config/test_device$i.ini &
done
```

**观察指标**：
- CPU使用率
- 内存使用量
- 网络带宽
- 响应延迟

## 测试报告模板

```
心跳机制测试报告
================

测试日期: 2026-02-13
测试人员: [姓名]

测试环境:
- 操作系统: Ubuntu 20.04
- Python版本: 3.8.10
- OpenCV版本: 4.5.0

测试结果:
✓ 设备注册: 通过
✓ 心跳发送: 通过
✓ 离线检测: 通过
✓ 设备重连: 通过
✓ 多设备管理: 通过

性能指标:
- 心跳间隔: 30秒
- 离线检测延迟: 90秒
- 网络开销: 16字节/次
- CPU占用: <1%

问题记录:
[无/记录发现的问题]

结论:
心跳机制工作正常，满足设计要求。
```

## 下一步

测试通过后，可以：
1. 调整心跳参数以适应实际环境
2. 部署到生产环境
3. 配置多个边缘设备
4. 添加监控告警功能
